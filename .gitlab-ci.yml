include:
  - template: 'Workflows/Branch-Pipelines.gitlab-ci.yml'

stages:
  - p4_sim
  - rtl_sim
  - bitfile
  - package
  - trigger_downstream

variables:
  GIT_STRATEGY: clone

.common:
  image: $CI_REGISTRY/ht/xilinx-tools-docker:21975-g8bb7b6c3
  before_script:
    - source /opt/Xilinx/Vivado/2021.2/settings64.sh
  variables:
    XILINXD_LICENSE_FILE: "2100@dmv.es.net"
    # Required to keep click python module happy
    LC_ALL: C.UTF-8
    LANG: C.UTF-8
    GIT_SUBMODULE_STRATEGY: recursive

p4bm:
  stage: p4_sim
  extends: .common
  tags:
    - ht-sim
  script:
    - make -C src/p4_app/p4/sim build sim-all
    - make -C examples/p4_simple/p4/sim sim-all
    - make -C examples/p4_hbm/p4/sim sim-all
    - make -C examples/unsupported/p4_example/p4/sim build sim-all
  artifacts:
    name: "artifacts.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    paths:
      - src/p4_app/p4/sim
      - examples/p4_simple/p4/sim
      - examples/p4_hbm/p4/sim
      - examples/unsupported/p4_example/p4/sim
  needs: []

sim_p4_apps:
  stage: rtl_sim
  extends: .common
  tags:
    - ht-sim
  script:
    - make -C src/p4_app/tests/regression
    - grep 'PASSED.*suites passing' src/p4_app/tests/regression/run_0/sim.log
    - make -C examples/p4_hbm/tests/regression
    - grep 'PASSED.*suites passing' examples/p4_hbm/tests/regression/run_0/sim.log
    - make -C examples/unsupported/p4_example/tests/regression
    - grep 'PASSED.*suites passing' examples/unsupported/p4_example/tests/regression/run_0/sim.log
  artifacts:
    name: "artifacts.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    reports:
      junit:
        - src/p4_app/tests/regression/run_0/tests.xml
        - examples/p4_hbm/tests/regression/run_0/tests.xml
        - examples/unsupported/p4_example/tests/regression/run_0/tests.xml
    when: always
  timeout: 2h
  needs: []

sim_platform:
  stage: rtl_sim
  extends: .common
  tags:
    - ht-sim
  script:
    - make -C src/smartnic_322mhz/tests/regression
    - grep 'PASSED.*suites passing' src/smartnic_322mhz/tests/regression/run_0/sim.log
    - make -C examples/unsupported/p2p/tests.smartnic_322mhz/regression
    - grep 'PASSED.*suites passing' examples/unsupported/p2p/tests.smartnic_322mhz/regression/run_0/sim.log
  artifacts:
    name: "artifacts.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    reports:
      junit:
        - src/smartnic_322mhz/tests/regression/run_0/tests.xml
        - examples/unsupported/p2p/tests.smartnic_322mhz/regression/run_0/tests.xml
    when: always
  timeout: 2h
  needs: []

.bitfile:
  stage: bitfile
  extends: .common
  tags:
    - ht-synth
  script:
    - make -C $EXAMPLES_DIR/$SN_HW_APP_NAME build BUILD_NAME=open-nic-ci
  artifacts:
    name: "artifacts.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    paths:
      - src
      - esnet-fpga-library
      - examples
      - open-nic-shell
    exclude:
      - .git/**
      - .git
      - .gitignore
      - .gitlab-ci.yml
      - .gitmodules
    when: always
    expire_in: 2 weeks
  timeout: 8h
  needs: []

build_p4_example:
  extends: .bitfile
  variables:
    EXAMPLES_DIR: examples/unsupported
    SN_HW_APP_NAME: p4_example

build_p2p:
  extends: .bitfile
  variables:
    EXAMPLES_DIR: examples/unsupported
    SN_HW_APP_NAME: p2p

build_p4_simple:
  extends: .bitfile
  variables:
    EXAMPLES_DIR: examples
    SN_HW_APP_NAME: p4_simple

build_p4_hbm:
  extends: .bitfile
  variables:
    EXAMPLES_DIR: examples
    SN_HW_APP_NAME: p4_hbm

build_vanilla_ons:
  stage: bitfile
  extends: .common
  tags:
    - ht-synth
  script:
    - make -f makefile.esnet vanilla_bitfile
  artifacts:
    name: "artifacts.vanilla.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    paths:
      - vanilla_artifact
    exclude:
      - .git/**
      - .git
      - .gitignore
      - .gitlab-ci.yml
      - .gitmodules
    when: always
    expire_in: 2 weeks
  timeout: 8h
  needs: []
  rules:
    - when: manual
      allow_failure: true

.hwapi:
  stage: package
  extends: .common
  tags:
    - ht-misc
  before_script: []
  script:
    - unzip $EXAMPLES_DIR/$SN_HW_APP_NAME/artifacts/open-nic-ci/artifacts.esnet-smartnic-hw.export_hwapi.0.zip
    - |
      cat <<_EOF >> hwapi.env
      SN_HW_HWAPI_JOB_NUMBER=$CI_JOB_ID
      _EOF
    - cat hwapi.env
  artifacts:
    name: "artifacts.$SN_HW_APP_NAME.$CI_PIPELINE_ID"
    paths:
      - esnet-smartnic-hwapi
    when: always
    expire_in: 3 month
    reports:
      dotenv:
        hwapi.env
  timeout: 30m

hwapi_p4_example:
  extends: .hwapi
  variables:
    EXAMPLES_DIR: examples/unsupported
    SN_HW_APP_NAME: p4_example
  needs:
    - build_p4_example

hwapi_p2p:
  extends: .hwapi
  variables:
    EXAMPLES_DIR: examples/unsupported
    SN_HW_APP_NAME: p2p
  needs:
    - build_p2p

hwapi_p4_simple:
  extends: .hwapi
  variables:
    EXAMPLES_DIR: examples
    SN_HW_APP_NAME: p4_simple
  needs:
    - build_p4_simple

hwapi_p4_hbm:
  extends: .hwapi
  variables:
    EXAMPLES_DIR: examples
    SN_HW_APP_NAME: p4_hbm
  needs:
    - build_p4_hbm

.trigger_fw:
  stage: trigger_downstream
  variables:
    SN_HW_GROUP: $CI_PROJECT_NAMESPACE
    SN_HW_REPO: $CI_PROJECT_NAME
    SN_HW_BRANCH: $CI_COMMIT_BRANCH
    # override the artifact URL in the triggered repo so it pulls directly from the hwapi job from this pipeline
    ESNET_SMARTNIC_HWAPI_URL: "$CI_PROJECT_URL/-/jobs/$SN_HW_HWAPI_JOB_NUMBER/artifacts/download?file_type=archive"
  trigger:
    project: ht/esnet-smartnic-fw
    branch: main
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: manual
      allow_failure: true

fw_p4_example:
  extends: .trigger_fw
  variables:
    SN_HW_APP_NAME: p4_example
    SN_HW_API_JOB: hwapi_p4_example
  needs:
    - hwapi_p4_example

fw_p4_simple:
  extends: .trigger_fw
  variables:
    SN_HW_APP_NAME: p4_simple
    SN_HW_API_JOB: hwapi_p4_simple
  needs:
    - hwapi_p4_simple

fw_p4_hbm:
  extends: .trigger_fw
  variables:
    SN_HW_APP_NAME: p4_hbm
    SN_HW_API_JOB: hwapi_p4_hbm
  needs:
    - hwapi_p4_hbm
