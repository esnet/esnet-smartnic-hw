# -----------------------------------------------
# Component setup
# -----------------------------------------------
COMPONENT_ROOT := ..

include $(COMPONENT_ROOT)/config.mk

APP_ROOT ?= $(PROJ_ROOT)/src/smartnic_app/blackbox

# -----------------------------------------------
# Specify top-level module
# -----------------------------------------------
TOP = smartnic

# ----------------------------------------------------
# Sources
#   List source files and include directories for component.
#   (see $(SCRIPTS_ROOT)/Makefiles/templates/sources.mk)
#   NOTE: along with explicitly-listed sources, all
#   source files from ./src are added automatically, and
#   .include is added as an include directory automatically.
# ----------------------------------------------------
SRC_FILES =
INC_DIRS =
SRC_LIST_FILES =

# ----------------------------------------------------
# Dependencies
#   List subcomponent and external library dependencies
#   (see $SCRIPTS_ROOT/Makefiles/templates/dependencies.mk)
# ----------------------------------------------------
SUBCOMPONENTS = \
    smartnic.rtl

# -----------------------------------------------
# Options
# -----------------------------------------------
SOURCES_TCL_USER = $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl

# ----------------------------------------------------
# Targets
# ----------------------------------------------------
all: opt validate

pre_synth: app_setup _pre_synth
synth:     _build_core_synth
opt:       _build_core_opt
place:     _build_core_place
validate:  _build_core_validate
info:      _build_core_info _app_info
clean:     _build_clean

.PHONY: pre_synth synth opt validate info clean

# ----------------------------------------------------
# Info targets
# ----------------------------------------------------
_app_info:
	@echo "------------------------------------------------------"
	@echo "Application configuration"
	@echo "------------------------------------------------------"
	@echo "APP_ROOT           : $(APP_ROOT)"

.PHONY: _app_info

# ----------------------------------------------------
# Project management targets
# ----------------------------------------------------
proj       : _proj
proj_clean : _proj_clean

.PHONY: proj proj_clean

# ----------------------------------------------------
# Application configuration targets
# ----------------------------------------------------
app_dec: $(APP_ROOT)/app_if/smartnic_app_decoder.yaml
	@cp $(APP_ROOT)/app_if/smartnic_app_decoder.yaml $(COMPONENT_ROOT)/regio/

app_srcs_ooc: | $(COMPONENT_OUT_SYNTH_PATH)
	@echo "# =====================================================" > $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# Source listing for $(COMPONENT_NAME) (OOC)" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "#" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# NOTE: This file is autogenerated. DO NOT EDIT." >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# =====================================================" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# NOTE: most source files for $(COMPONENT_NAME) are automatically included from:" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "#       $(COMPONENT_OUT_SYNTH_PATH)/sources.tcl" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "#       However, the application-specific sources are not included and are provided in this file for the OOC build flow." >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# Incorporate SmartNIC application as black box" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "# ---------------------------------------------" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl
	@echo "add_file -quiet $(SRC_ROOT)/smartnic_app/blackbox/rtl/src/smartnic_app.sv" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources_ooc.tcl

app_srcs: | $(COMPONENT_OUT_SYNTH_PATH) 
	@echo "# Incorporate SmartNIC application" > $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl
	@echo "# ---------------------------------" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl
	@echo "read_checkpoint -cell box_322mhz_inst/smartnic/smartnic_app $(APP_ROOT)/app_if/smartnic_app.dcp" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl

app_setup: app_dec app_srcs_ooc app_srcs

.PHONY: app_dec app_srcs_ooc app_srcs app_setup

$(APP_ROOT)/app_if/smartnic_app_decoder.yaml $(APP_ROOT)/app_if/smartnic_app.dcp:
	$(error Application output products not available at $(APP_ROOT)/app_if. Application must be built before smartnic.)

# -----------------------------------------------
# Include Vivado definitions/targets
# -----------------------------------------------
include $(SCRIPTS_ROOT)/Makefiles/vivado_build_core.mk
