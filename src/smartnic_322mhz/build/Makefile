# -----------------------------------------------
# Component setup
# -----------------------------------------------
COMPONENT_ROOT := ..

include $(COMPONENT_ROOT)/config.mk

APP_ROOT ?= $(PROJ_ROOT)/src/smartnic_322mhz_app/blackbox

# -----------------------------------------------
# Specify top-level module
# -----------------------------------------------
TOP = smartnic_322mhz

# ----------------------------------------------------
# Sources
#   List source files and include directories for component.
#   (see $(SCRIPTS_ROOT)/Makefiles/templates/sources.mk)
#   NOTE: along with explictly-listed sources, all
#   source files from ./src are added automatically, and
#   .include is added as an include directory automatically.
# ----------------------------------------------------
SRC_FILES =
INC_DIRS =
SRC_LIST_FILES =

# ----------------------------------------------------
# Dependencies
#   List subcomponent and external library dependencies
#   (see $SCRIPTS_ROOT/Makefiles/templates/dependencies.mk)
# ----------------------------------------------------
SUBCOMPONENTS = \
    smartnic_322mhz.rtl

# ----------------------------------------------------
# Targets
# ----------------------------------------------------
all: opt validate

reg: cp_app_dec

pre_synth: reg app_pkg app_srcs _pre_synth
	@echo "# =====================================================" > sources.tcl
	@echo "# Source listing for $(COMPONENT_NAME) (OOC)" >> sources.tcl
	@echo "#" >> sources.tcl
	@echo "# NOTE: This file is autogenerated. DO NOT EDIT." >> sources.tcl
	@echo "# =====================================================" >> sources.tcl
	@echo "# NOTE: most source files for $(COMPONENT_NAME) are automatically included from:" >> sources.tcl
	@echo "#       $(COMPONENT_OUT_SYNTH_PATH)/sources.tcl." >> sources.tcl
	@echo "#       However, the application-specific sources are not included and are provided in this file for the OOC build flow." >> sources.tcl
	@echo >> sources.tcl
	@echo "# Incorporate SmartNIC application as black box" >> sources.tcl
	@echo "# ---------------------------------------------" >> sources.tcl
	@echo "add_file -quiet $(SRC_ROOT)/smartnic_322mhz_app/blackbox/rtl/src/smartnic_322mhz_app.sv" >> sources.tcl
	@echo "add_file -quiet $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv" >> sources.tcl

synth:     _build_core_synth
opt:       _build_core_opt
place:     _build_core_place
validate:  _build_core_validate
info:      _build_core_info _app_info

clean:     _build_clean
	@rm -rf *sources.tcl

.PHONY: pre_synth synth opt validate info clean

cp_app_dec: $(APP_ROOT)/app_if/smartnic_322mhz_app_decoder.yaml
	@cp $(APP_ROOT)/app_if/smartnic_322mhz_app_decoder.yaml $(COMPONENT_ROOT)/regio/

app_srcs: | $(COMPONENT_OUT_SYNTH_PATH) 
	@echo "# Incorporate SmartNIC application" > $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl
	@echo "# ---------------------------------" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl
	@echo "add_file -quiet $(APP_ROOT)/app_if/smartnic_322mhz_app_pkg.sv" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl
	@echo "read_checkpoint -cell box_322mhz_inst/smartnic_322mhz/smartnic_322mhz_app $(APP_ROOT)/app_if/smartnic_322mhz_app.dcp" >> $(COMPONENT_OUT_SYNTH_PATH)/app_sources.tcl

# Create application package for standalone smartnic_322mhz build only; not used during full application build
# - HBM is enabled by default except when target board is AU250
app_pkg: | $(COMPONENT_OUT_PATH)
	@echo "// ====================================================="     > $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "// SmartNIC application package for $(COMPONENT_NAME) (OOC)" >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "//"                                                          >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "// Board: $(BOARD)"                                          >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "//"                                                          >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "// NOTE: This file is autogenerated. DO NOT EDIT."           >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "// ====================================================="    >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "package smartnic_322mhz_app_pkg;"                            >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo                                                               >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "    localparam bit INCLUDE_HBM = $(if $(filter au250,$(BOARD)),0,1);" >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo                                                               >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv
	@echo "endpackage: smartnic_322mhz_app_pkg"                         >> $(COMPONENT_OUT_PATH)/smartnic_322mhz_app_pkg.sv

.PHONY: cp_app_dec app_srcs app_pkg

$(APP_ROOT)/app_if/smartnic_322mhz_app_decoder.yaml $(APP_ROOT)/app_if/smartnic_322mhz_app_pkg.sv $(APP_ROOT)/app_if/smartnic_322mhz_app.dcp:
	$(error Application output products not available at $(APP_ROOT)/app_if. Application must be build before smartnic_322mhz.)

# ----------------------------------------------------
# Info targets
# ----------------------------------------------------
_app_info:
	@echo "------------------------------------------------------"
	@echo "Application configuration"
	@echo "------------------------------------------------------"
	@echo "APP_ROOT           : $(APP_ROOT)"

.PHONY: _app_info

# ----------------------------------------------------
# Project management targets
# ----------------------------------------------------
proj       : _proj
proj_clean : _proj_clean

.PHONY: proj proj_clean

# -----------------------------------------------
# Include Vivado definitions/targets
# -----------------------------------------------
include $(SCRIPTS_ROOT)/Makefiles/vivado_build_core.mk
